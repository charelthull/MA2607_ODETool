<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODE Mastery Prototype</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax for rendering equations -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .step-container {
            transition: all 0.5s ease-in-out;
        }
        .selected-btn {
            background-color: #4f46e5 !important; /* Tailwind's indigo-600 */
            color: white !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .ai-message {
            background-color: #e2e8f0; /* Tailwind's gray-200 */
            border-radius: 1.5rem 1.5rem 1.5rem 0;
            padding: 0.75rem 1rem;
            max-width: 80%;
            align-self: flex-start;
        }
        .user-message {
            background-color: #4f46e5; /* Tailwind's indigo-600 */
            color: white;
            border-radius: 1.5rem 1.5rem 0 1.5rem;
            padding: 0.75rem 1rem;
            max-width: 80%;
            align-self: flex-end;
        }
        .tracker-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            color: #9ca3af;
            font-weight: 600;
            cursor: pointer; /* Added for clickable items */
        }
        .tracker-item.completed {
            background-color: #22c55e; /* green-500 */
            border-color: #16a34a; /* green-600 */
            color: white;
        }
        .tracker-item.active {
            background-color: #4f46e5; /* indigo-600 */
            border-color: #4338ca; /* indigo-700 */
            color: white;
        }
        .progress-bar-segment {
            flex-grow: 1;
            height: 4px;
            background-color: #e5e7eb;
        }
        canvas {
            display: block;
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #d1d5db; /* Added border */
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <!-- Main Application Container -->
    <div class="bg-white rounded-xl shadow-2xl p-6 sm:p-10 w-full max-w-5xl">

        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-2">ODE Mastery</h1>
        <p class="text-center text-gray-500 mb-2">A learning and exploration tool</p>

        <!-- Main Menu -->
        <div id="main-menu-container" class="step-container">
            <h2 class="text-2xl font-semibold mb-6 text-center">Choose Your Path</h2>
            <div class="space-y-4">
                <button onclick="showOdeMastery()" class="w-full py-4 bg-indigo-600 text-white rounded-lg font-semibold text-xl hover:bg-indigo-700 transition-colors duration-300">
                    ODE Mastery Strategy
                </button>
                <button onclick="showInteractiveTool()" class="w-full py-4 bg-gray-600 text-white rounded-lg font-semibold text-xl hover:bg-gray-700 transition-colors duration-300">
                    Interactive Solutions Tool
                </button>
            </div>
        </div>

        <!-- ODE Mastery Container -->
        <div id="ode-mastery-container" class="step-container hidden">
            <!-- Score Display -->
            <div class="text-center text-xl font-bold text-gray-700 mb-8">
                Score: <span id="user-score">0</span>
            </div>

            <!-- Progress Tracker -->
            <div id="progress-tracker" class="flex justify-between items-center mb-8 px-4 sm:px-4 flex-wrap">
                <div id="tracker-1" class="tracker-item active" onclick="handleTrackerClick(1)">1</div>
                <div class="h-1 flex-grow bg-gray-300 mx-1"></div>
                <div id="tracker-2" class="tracker-item" onclick="handleTrackerClick(2)">2</div>
                <div class="h-1 flex-grow bg-gray-300 mx-1"></div>
                <div id="tracker-3" class="tracker-item" onclick="handleTrackerClick(3)">3</div>
                <div class="h-1 flex-grow bg-gray-300 mx-1"></div>
                <div id="tracker-4" class="tracker-item" onclick="handleTrackerClick(4)">4</div>
                <div class="h-1 flex-grow bg-gray-300 mx-1"></div>
                <div id="tracker-5" class="tracker-item" onclick="handleTrackerClick(5)">5</div>
                <div class="h-1 flex-grow bg-gray-300 mx-1"></div>
                <div id="tracker-6" class="tracker-item" onclick="handleTrackerClick(6)">6</div>
            </div>

            <!-- Message Box for persistent feedback -->
            <div id="message-box" class="hidden p-4 mb-6 text-sm text-blue-800 rounded-lg bg-blue-50"></div>

            <!-- Level 1: Quick ID Quiz -->
            <div id="level-1-container" class="step-container">
                <h2 class="text-2xl font-semibold mb-4 text-center">Level 1: Identify Standard Second-Order ODEs</h2>
                <p class="text-gray-700 mb-6">Which of these are a **second-order constant-coefficient linear homogeneous ODE**? Select 'Yes' or 'No' for each.</p>

                <div id="level-1-questions" class="space-y-4">
                    <!-- Questions will be dynamically inserted here -->
                </div>

                <button id="level-1-submit" onclick="submitQuiz()" class="mt-8 w-full bg-blue-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors duration-300">Submit Answers</button>
                <button id="level-1-new-quiz-btn" onclick="resetLevel1()" class="hidden mt-4 w-full bg-gray-500 text-white py-3 rounded-lg font-semibold text-lg hover:bg-gray-600 transition-colors duration-300">Try Another Level 1 Quiz</button>
                <button id="next-level-btn" onclick="startLevel(2)" class="hidden mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-indigo-700 transition-colors duration-300">Continue to Level 2</button>
            </div>

            <!-- AI-Guided Solver Container for Levels 2, 3, 4, and 5 -->
            <div id="ai-level-container" class="step-container hidden">
                <h2 id="ai-level-title" class="text-2xl font-semibold mb-4 text-center"></h2>
                <p id="ai-level-subtitle" class="text-gray-700 mb-6"></p>

                <div id="conversation-container" class="bg-gray-50 p-4 rounded-lg h-96 overflow-y-auto flex flex-col space-y-4 mb-4">
                    <!-- AI and user messages will be injected here -->
                    <div id="loading-spinner" class="hidden flex justify-center items-center h-full">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
                    </div>
                </div>

                <div class="flex">
                    <input type="text" id="user-input" placeholder="Enter your answer here..." class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="submit-btn" onclick="submitAIResponse()" class="px-6 py-3 bg-blue-600 text-white rounded-r-lg font-semibold hover:bg-blue-700 transition-colors duration-300">Submit</button>
                </div>
                <button id="ai-next-level-btn" onclick="" class="hidden mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-indigo-700 transition-colors duration-300">Continue</button>
                <button id="ai-new-example-btn" onclick="" class="hidden mt-4 w-full bg-gray-500 text-white py-3 rounded-lg font-semibold text-lg hover:bg-gray-600 transition-colors duration-300">Try Another Example</button>
            </div>

            <!-- Level 6: Damping Classification -->
            <div id="level-6-container" class="step-container hidden">
                <h2 class="text-2xl font-semibold mb-4 text-center">Level 6: Damping Classification</h2>
                <p class="text-gray-700 mb-6">Match each ODE to its damping characteristic by selecting the correct option.</p>

                <div id="level-6-questions" class="space-y-6">
                    <!-- Questions will be dynamically inserted here -->
                </div>

                <button id="level-6-submit" onclick="submitLevel6Quiz()" class="mt-8 w-full bg-blue-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors duration-300">Submit Answers</button>
                <button id="level-6-new-quiz-btn" onclick="resetLevel6()" class="hidden mt-4 w-full bg-gray-500 text-white py-3 rounded-lg font-semibold text-lg hover:bg-gray-600 transition-colors duration-300">Try Another Level 6 Quiz</button>
                <button id="level-6-finish-btn" onclick="showMenu()" class="hidden mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-indigo-700 transition-colors duration-300">Return to Main Menu</button>
            </div>
             <!-- New button to return to the main menu from any level -->
            <button onclick="showMenu()" class="mt-8 w-full bg-gray-500 text-white py-3 rounded-lg font-semibold text-lg hover:bg-gray-600 transition-colors duration-300">Return to Main Menu</button>
        </div>

        <!-- Interactive Tool Container -->
        <div id="interactive-tool-container" class="step-container hidden">
            <h2 class="text-2xl font-semibold mb-4 text-center">Interactive Solutions Tool</h2>
            <p class="text-gray-700 mb-6">Explore how changing coefficients and initial conditions affects the solution to the ODE: $y'' + by' + cy = 0$.</p>

            <div class="flex flex-col space-y-4">
                <!-- Input Controls -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center space-x-2">
                        <label for="b-input" class="font-semibold w-1/4">b:</label>
                        <input type="number" id="b-input" value="1" step="0.1" class="w-3/4 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="c-input" class="font-semibold w-1/4">c:</label>
                        <input type="number" id="c-input" value="1" step="0.1" class="w-3/4 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="y0-input" class="font-semibold w-1/4">y(0):</label>
                        <input type="number" id="y0-input" value="1" step="0.1" class="w-3/4 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="yp0-input" class="font-semibold w-1/4">y'(0):</label>
                        <input type="number" id="yp0-input" value="0" step="0.1" class="w-3/4 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="t_start-input" class="font-semibold w-1/4">t start:</label>
                        <input type="number" id="t_start-input" value="0" step="0.1" class="w-3/4 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="t_end-input" class="font-semibold w-1/4">t end:</label>
                        <input type="number" id="t_end-input" value="10" step="0.1" class="w-3/4 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>

                <!-- Damping Type Display -->
                <div class="bg-gray-100 p-4 rounded-lg text-center">
                    <span class="font-semibold">Damping Type:</span> <span id="damping-type" class="font-bold text-indigo-600">Critically Damped</span>
                </div>

                <!-- Plot Canvases with Toggle Switch -->
                <div class="relative w-full">
                    <div class="flex justify-center mb-4 space-x-2">
                        <button id="time-plot-btn" onclick="togglePlotView('time')" class="px-4 py-2 rounded-full font-semibold text-sm transition-colors duration-200 selected-btn">Time Domain ($y$ vs $t$)</button>
                        <button id="phase-plot-btn" onclick="togglePlotView('phase')" class="px-4 py-2 rounded-full font-semibold text-sm transition-colors duration-200 bg-gray-200 text-gray-800 hover:bg-gray-300">Phase Space ($y'$ vs $y$)</button>
                    </div>
                    <div id="plot-container" class="relative w-full h-96">
                        <canvas id="solution-canvas" class="absolute w-full h-full"></canvas>
                        <canvas id="phase-space-canvas" class="absolute w-full h-full hidden"></canvas>
                        <div id="no-solution-message" class="absolute inset-0 flex items-center justify-center text-gray-500 hidden">
                            Cannot plot solution. Please check your parameters.
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="showMenu()" class="mt-8 w-full bg-gray-500 text-white py-3 rounded-lg font-semibold text-lg hover:bg-gray-600 transition-colors duration-300">Return to Main Menu</button>
        </div>

    </div>

    <script>
        // Global variables and constants
        let userAnswers = {};
        let level1CorrectAnswers = {};
        let level6CorrectAnswers = {};
        let chatHistory = [];
        let currentLevel = 1;
        let userScore = 0;
        let allowSkip = true;

        // DOM elements
        const mainMenuContainer = document.getElementById('main-menu-container');
        const odeMasteryContainer = document.getElementById('ode-mastery-container');
        const interactiveToolContainer = document.getElementById('interactive-tool-container');
        const messageBox = document.getElementById('message-box');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const level1Container = document.getElementById('level-1-container');
        const aiLevelContainer = document.getElementById('ai-level-container');
        const level1SubmitBtn = document.getElementById('level-1-submit');
        const level1NewQuizBtn = document.getElementById('level-1-new-quiz-btn');
        const conversationContainer = document.getElementById('conversation-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const userInput = document.getElementById('user-input');
        const submitBtn = document.getElementById('submit-btn');
        const aiLevelTitle = document.getElementById('ai-level-title');
        const aiLevelSubtitle = document.getElementById('ai-level-subtitle');
        const aiNextLevelBtn = document.getElementById('ai-next-level-btn');
        const aiNewExampleBtn = document.getElementById('ai-new-example-btn');
        const userScoreDisplay = document.getElementById('user-score');
        const level6Container = document.getElementById('level-6-container');
        const level6SubmitBtn = document.getElementById('level-6-submit');
        const level6NewQuizBtn = document.getElementById('level-6-new-quiz-btn');
        const level6FinishBtn = document.getElementById('level-6-finish-btn');

        // Interactive Tool elements
        const bInput = document.getElementById('b-input');
        const cInput = document.getElementById('c-input');
        const y0Input = document.getElementById('y0-input');
        const yp0Input = document.getElementById('yp0-input');
        const tStartInput = document.getElementById('t_start-input');
        const tEndInput = document.getElementById('t_end-input');
        const dampingTypeDisplay = document.getElementById('damping-type');
        const solutionCanvas = document.getElementById('solution-canvas');
        const phaseSpaceCanvas = document.getElementById('phase-space-canvas');
        const solutionCtx = solutionCanvas.getContext('2d');
        const phaseSpaceCtx = phaseSpaceCanvas.getContext('2d');
        const noSolutionMessage = document.getElementById('no-solution-message');
        const timePlotBtn = document.getElementById('time-plot-btn');
        const phasePlotBtn = document.getElementById('phase-plot-btn');


        const levelTitles = {
            2: "Level 2: Real, Distinct Roots",
            3: "Level 3: Real, Repeated Roots",
            4: "Level 4: Complex Conjugate Roots",
            5: "Level 5: Initial Conditions",
            6: "Level 6: Damping Classification"
        };
        const levelTopics = {
            2: "ODEs with real, distinct roots.",
            3: "ODEs with real, repeated roots.",
            4: "ODEs with complex conjugate roots.",
            5: "solving initial value problems for ODEs.",
            6: "classifying solutions based on damping."
        };
        const levelInitialPrompts = {
            2: "Generate a second-order linear homogeneous ODE with real distinct roots for a student to solve. Provide the ODE and the first step of the solution process as guidance, which is to find the characteristic equation. Do not provide the answer. Ensure the ODE is clearly formatted using LaTeX. Your response should start with the ODE, followed by the first instruction.",
            3: "Generate a second-order linear homogeneous ODE with real repeated roots for a student to solve. Provide the ODE and the first step of the solution process as guidance, which is to find the characteristic equation. Do not provide the answer. Ensure the ODE is clearly formatted using LaTeX. Your response should start with the ODE, followed by the first instruction.",
            4: "Generate a second-order linear homogeneous ODE with complex conjugate roots for a student to solve. Provide the ODE and the first step of the solution process as guidance, which is to find the characteristic equation. Do not provide the answer. Ensure the ODE is clearly formatted using LaTeX. Your response should start with the ODE, followed by the first instruction.",
            5: "Generate a second-order linear homogeneous ODE and a set of initial conditions. Guide the student to first find the general solution, and then apply the initial conditions to find the specific solution. The first step is to find the characteristic equation. Ensure the ODE and initial conditions are clearly formatted using LaTeX. Your response should start with the ODE and initial conditions, followed by the first instruction."
        };
        const dampingChoices = ['Undamped', 'Lightly Damped', 'Critically Damped', 'Overdamped'];

        // --- Main Menu Functions ---
        window.showMenu = function() {
            mainMenuContainer.classList.remove('hidden');
            odeMasteryContainer.classList.add('hidden');
            interactiveToolContainer.classList.add('hidden');
        };

        window.showOdeMastery = function() {
            mainMenuContainer.classList.add('hidden');
            odeMasteryContainer.classList.remove('hidden');
            startLevel(1);
        };

        window.showInteractiveTool = function() {
            mainMenuContainer.classList.add('hidden');
            odeMasteryContainer.classList.add('hidden');
            interactiveToolContainer.classList.remove('hidden');
            // Set up resize observer for responsive canvas
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    const { width, height } = entry.contentRect;
                    solutionCanvas.width = width;
                    solutionCanvas.height = height;
                    phaseSpaceCanvas.width = width;
                    phaseSpaceCanvas.height = height;
                }
                plotSolutions();
            });
            resizeObserver.observe(document.getElementById('plot-container'));
            setupInteractiveToolListeners();
        };

        // --- ODE Mastery Functions ---
        function updateScore(points) {
            userScore += points;
            userScoreDisplay.textContent = userScore;
        }

        function showMessage(text, isError = false) {
            messageBox.innerHTML = text;
            messageBox.classList.remove('hidden', 'text-green-800', 'bg-green-50', 'text-red-800', 'bg-red-50', 'text-blue-800', 'bg-blue-50');
            if (isError) {
                messageBox.classList.add('text-red-800', 'bg-red-50');
            } else {
                messageBox.classList.add('text-green-800', 'bg-green-50');
            }
            messageBox.classList.add('block');
            MathJax.typesetPromise();
        }

        function clearMessage() {
            messageBox.innerHTML = '';
            messageBox.className = 'hidden p-4 mb-6 text-sm text-blue-800 rounded-lg bg-blue-50';
        }

        function updateProgressTracker() {
            document.querySelectorAll('.tracker-item').forEach(item => {
                item.classList.remove('active', 'completed');
                item.classList.add('bg-gray-200');
            });
            for (let i = 1; i <= currentLevel; i++) {
                const trackerItem = document.getElementById(`tracker-${i}`);
                if (trackerItem) {
                    trackerItem.classList.remove('bg-gray-200');
                    if (i === currentLevel) {
                        trackerItem.classList.add('active');
                    } else {
                        trackerItem.classList.add('completed');
                    }
                }
            }
        }

        window.handleTrackerClick = function(level) {
            if (allowSkip || level <= currentLevel) {
                startLevel(level);
            } else {
                showMessage(`You have not unlocked Level ${level} yet. Please complete the current level first.`, true);
            }
        };

        window.generateLevel1Questions = function() {
            const questions = [
                {
                    text: '$y\'\' + 3y\' + 2y = 0$',
                    correct: true,
                    reason: null
                },
                {
                    text: '$y\'\' + \\sin(x)y\' + y = 0$',
                    correct: false,
                    reason: 'The coefficient $\\sin(x)$ is not constant.'
                },
                {
                    text: '$y\'\' + 5y\' = 0$',
                    correct: true,
                    reason: null
                },
                {
                    text: '$y\' + 5y = 0$',
                    correct: false,
                    reason: 'This is a first-order ODE.'
                },
                {
                    text: '$y\'\' + 4y\' + y^2 = 0$',
                    correct: false,
                    reason: 'The term $y^2$ makes it non-linear.'
                },
                {
                    text: '$y\'\' - 2y\' + y = \\cos(x)$',
                    correct: false,
                    reason: 'The ODE is not homogeneous due to the non-zero right-hand side.'
                }
            ];
            let selectedQuestions = [];
            const correctQuestions = questions.filter(q => q.correct);
            const incorrectQuestions = questions.filter(q => !q.correct);
            const shuffledCorrect = correctQuestions.sort(() => 0.5 - Math.random());
            const shuffledIncorrect = incorrectQuestions.sort(() => 0.5 - Math.random());
            selectedQuestions = shuffledCorrect.slice(0, 2).concat(shuffledIncorrect.slice(0, 2));
            selectedQuestions.sort(() => 0.5 - Math.random());
            const container = document.getElementById('level-1-questions');
            container.innerHTML = '';
            userAnswers = {};
            level1CorrectAnswers = {};
            selectedQuestions.forEach((q, index) => {
                const questionId = index;
                level1CorrectAnswers[questionId] = { answer: q.correct, reason: q.reason };
                const questionHtml = `
                    <div class="bg-gray-100 p-4 rounded-lg flex flex-col sm:flex-row items-start sm:items-center justify-between" data-question-id="${questionId}">
                        <span class="font-mono text-lg">${q.text}</span>
                        <div class="mt-2 sm:mt-0 flex space-x-2">
                            <button onclick="checkAnswer(this, ${questionId}, true)" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-800 font-medium hover:bg-gray-400 transition-colors">Yes</button>
                            <button onclick="checkAnswer(this, ${questionId}, false)" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-800 font-medium hover:bg-gray-400 transition-colors">No</button>
                        </div>
                    </div>
                `;
                container.innerHTML += questionHtml;
            });
        };

        window.checkAnswer = function(button, questionIndex, answer) {
            userAnswers[questionIndex] = answer;
            const parentDiv = button.closest('[data-question-id]');
            const buttons = parentDiv.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.classList.remove('selected-btn');
                btn.classList.add('bg-gray-300', 'hover:bg-gray-400');
            });
            button.classList.add('selected-btn');
            button.classList.remove('bg-gray-300', 'hover:bg-gray-400');
        };

        window.submitQuiz = function() {
            let allCorrect = true;
            let feedback = "";
            let correctCount = 0;
            for (const qId in level1CorrectAnswers) {
                if (userAnswers[qId] === undefined) {
                    showMessage("Please answer all questions before submitting.", true);
                    return;
                }
                if (userAnswers[qId] !== level1CorrectAnswers[qId].answer) {
                    allCorrect = false;
                    feedback += `<br/>- Question: ${document.querySelector(`[data-question-id="${qId}"] span`).textContent}. Incorrect. Reason: ${level1CorrectAnswers[qId].reason || 'N/A'}`;
                } else {
                    correctCount++;
                }
            }
            if (allCorrect) {
                updateScore(correctCount * 10);
                showMessage(`All answers are correct! You've mastered Level 1 and earned ${correctCount * 10} points!`, false);
                nextLevelBtn.classList.remove('hidden');
                level1SubmitBtn.classList.add('hidden');
                level1NewQuizBtn.classList.add('hidden');
                currentLevel = 2;
                updateProgressTracker();
            } else {
                updateScore(correctCount * 10);
                messageBox.innerHTML = `Some answers were incorrect. You earned ${correctCount * 10} points. Review the reasons below: ${feedback}`;
                messageBox.classList.remove('hidden');
                messageBox.classList.add('text-red-800', 'bg-red-50');
                level1NewQuizBtn.classList.remove('hidden');
                level1SubmitBtn.classList.add('hidden');
            }
            MathJax.typesetPromise();
        };

        window.resetLevel1 = function() {
            clearMessage();
            level1SubmitBtn.classList.remove('hidden');
            level1NewQuizBtn.classList.add('hidden');
            nextLevelBtn.classList.add('hidden');
            generateLevel1Questions();
            MathJax.typesetPromise();
        };

        window.startLevel = function(level) {
            currentLevel = level;
            updateProgressTracker();
            clearMessage();
            level1Container.classList.add('hidden');
            aiLevelContainer.classList.add('hidden');
            level6Container.classList.add('hidden');

            if (level === 1) {
                level1Container.classList.remove('hidden');
                resetLevel1();
            } else if (level === 6) {
                level6Container.classList.remove('hidden');
                resetLevel6();
            } else {
                aiLevelContainer.classList.remove('hidden');
                startAILevel();
            }
        };

        window.makeApiCall = async function(payload, retries = 0) {
            const apiKey = "AIzaSyCQ5Vre7EEexOV7_jZ8fSEX26wMjjfKqY0";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.status === 429 && retries < 5) {
                    const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return makeApiCall(payload, retries + 1);
                }
                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }
                const result = await response.json();
                if (!result.candidates || result.candidates.length === 0 || !result.candidates[0].content || !result.candidates[0].content.parts || result.candidates[0].content.parts.length === 0) {
                    throw new Error('Invalid API response format');
                }
                return result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        };

        window.startAILevel = async function() {
            clearMessage();
            conversationContainer.innerHTML = '';
            userInput.value = '';
            chatHistory = [];
            submitBtn.disabled = false;
            aiNextLevelBtn.classList.add('hidden');
            aiNewExampleBtn.classList.add('hidden');
            aiLevelTitle.textContent = levelTitles[currentLevel];
            aiLevelSubtitle.textContent = `Let's solve a problem on ${levelTopics[currentLevel].toLowerCase()}. The AI will guide you through the process.`;
            showLoading(true);
            const prompt = levelInitialPrompts[currentLevel];
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            try {
                const aiResponseText = await makeApiCall(payload);
                addMessageToConversation(aiResponseText, 'ai');
                chatHistory.push({ role: 'user', parts: [{ text: prompt }] });
                chatHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
            } catch (error) {
                addMessageToConversation("I'm sorry, I'm having trouble starting a new problem. Please try again later.", 'ai');
            } finally {
                showLoading(false);
                MathJax.typesetPromise();
            }
        };

        window.submitAIResponse = async function() {
            const userText = userInput.value.trim();
            if (userText === '') {
                return;
            }
            addMessageToConversation(userText, 'user');
            chatHistory.push({ role: 'user', parts: [{ text: userText }] });
            userInput.value = '';
            showLoading(true);
            submitBtn.disabled = true;
            const nextPrompt = `The student is currently working on Level ${currentLevel} of an ODE problem. The topic for this level is ${levelTopics[currentLevel]}. The student's response is: "${userText}". Evaluate their answer. If it is mathematically correct and represents a logical step, provide the next step. If it is incorrect, provide a hint without giving away the full answer. Be conversational and encouraging. Do not give away the final solution until the student reaches the end. Your response should always use LaTeX for equations and formatting. If the student has reached the final solution, provide a clear 'Congratulations!' message and the final solution.`
            chatHistory.push({ role: 'user', parts: [{ text: nextPrompt }] });
            const payload = { contents: chatHistory };
            try {
                const aiResponseText = await makeApiCall(payload);
                if (aiResponseText.toLowerCase().includes("incorrect") || aiResponseText.toLowerCase().includes("try again") || aiResponseText.toLowerCase().includes("not quite")) {
                    updateScore(-5);
                }
                addMessageToConversation(aiResponseText, 'ai');
                chatHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
                if (aiResponseText.toLowerCase().includes("congratulations")) {
                    updateScore(100);
                   if (currentLevel < 6) {
                       aiNextLevelBtn.classList.remove('hidden');
                       aiNextLevelBtn.textContent = `Continue to Level ${currentLevel + 1}`;
                       aiNextLevelBtn.onclick = () => startLevel(currentLevel + 1);
                   } else {
                       showMessage(`Congratulations on completing all six levels! You have mastered the basics of solving ODEs. Your final score is ${userScore}!`, false);
                       userInput.classList.add('hidden');
                       submitBtn.classList.add('hidden');
                       aiNewExampleBtn.classList.remove('hidden');
                       aiNewExampleBtn.textContent = 'Start Over';
                       aiNewExampleBtn.onclick = () => {
                            userScore = 0;
                            userScoreDisplay.textContent = userScore;
                            startLevel(1);
                        };
                   }
                   updateProgressTracker();
                }
            } catch (error) {
                addMessageToConversation("I'm sorry, I'm having trouble processing your response. Please try again.", 'ai');
                console.error('API call failed:', error);
            } finally {
                showLoading(false);
                submitBtn.disabled = false;
                MathJax.typesetPromise();
                conversationContainer.scrollTop = conversationContainer.scrollHeight;
            }
        };

        window.addMessageToConversation = function(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded-lg max-w-sm ${sender === 'user' ? 'bg-indigo-600 text-white self-end user-message' : 'bg-gray-200 text-gray-800 self-start ai-message'}`;
            messageDiv.innerHTML = text;
            conversationContainer.appendChild(messageDiv);
            MathJax.typesetPromise();
        };

        window.showLoading = function(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
        };

        window.generateRandomOde = function(dampingType) {
            let a, b, c;
            const random = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            let text = '';

            switch (dampingType) {
                case 'Undamped':
                    a = 1;
                    b = 0;
                    c = random(1, 10);
                    text = `$y'' + ${c}y = 0$`;
                    break;
                case 'Critically Damped':
                    const k = random(2, 6);
                    a = 1;
                    b = 2 * k;
                    c = k * k;
                    text = `$y'' + ${b}y' + ${c}y = 0$`;
                    break;
                case 'Overdamped':
                    a = 1;
                    b = random(6, 10);
                    c = random(1, b * b / 4 - 1);
                    text = `$y'' + ${b}y' + ${c}y = 0$`;
                    break;
                case 'Lightly Damped':
                    a = 1;
                    b = random(1, 4);
                    c = random(Math.ceil(b * b / 4) + 1, Math.ceil(b * b / 4) + 5);
                    text = `$y'' + ${b}y' + ${c}y = 0$`;
                    break;
            }
            return { text, correctAnswer: dampingType };
        }

        window.shuffleArray = function(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        window.generateLevel6Questions = function() {
            const dampingTypes = ['Undamped', 'Lightly Damped', 'Critically Damped', 'Overdamped'];
            shuffleArray(dampingTypes);
            const questions = dampingTypes.map(type => generateRandomOde(type));
            const container = document.getElementById('level-6-questions');
            container.innerHTML = '';
            userAnswers = {};
            level6CorrectAnswers = {};
            questions.forEach((q, index) => {
                const questionId = index;
                level6CorrectAnswers[questionId] = q.correctAnswer;
                const choicesHtml = dampingChoices.map(choice => `
                    <button onclick="checkLevel6Answer(this, ${questionId}, '${choice}')" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-800 font-medium hover:bg-gray-400 transition-colors">${choice}</button>
                `).join('');
                const questionHtml = `
                    <div class="bg-gray-100 p-4 rounded-lg flex flex-col items-start" data-question-id="${questionId}">
                        <span class="font-mono text-lg mb-4">${q.text}</span>
                        <div class="flex flex-wrap gap-2">
                            ${choicesHtml}
                        </div>
                    </div>
                `;
                container.innerHTML += questionHtml;
            });
            MathJax.typesetPromise();
        };

        window.checkLevel6Answer = function(button, questionIndex, answer) {
            userAnswers[questionIndex] = answer;
            const parentDiv = button.closest('[data-question-id]');
            const buttons = parentDiv.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.classList.remove('selected-btn');
                btn.classList.add('bg-gray-300', 'hover:bg-gray-400');
            });
            button.classList.add('selected-btn');
            button.classList.remove('bg-gray-300', 'hover:bg-gray-400');
        };

        window.submitLevel6Quiz = function() {
            let allCorrect = true;
            let feedback = "";
            let correctCount = 0;
            for (const qId in level6CorrectAnswers) {
                if (userAnswers[qId] === undefined) {
                    showMessage("Please answer all questions before submitting.", true);
                    return;
                }
                const isCorrect = userAnswers[qId] === level6CorrectAnswers[qId];
                if (isCorrect) {
                    correctCount++;
                }
                allCorrect = allCorrect && isCorrect;
            }
            if (allCorrect) {
                updateScore(correctCount * 25);
                showMessage(`All answers are correct! You've mastered the final level and earned ${correctCount * 25} points!`, false);
                level6SubmitBtn.classList.add('hidden');
                level6NewQuizBtn.classList.add('hidden');
                level6FinishBtn.classList.remove('hidden');
            } else {
                updateScore(correctCount * 25);
                feedback = `You got ${correctCount} out of 4 correct. Try again!`;
                showMessage(feedback, true);
                level6NewQuizBtn.classList.remove('hidden');
                level6SubmitBtn.classList.add('hidden');
            }
            MathJax.typesetPromise();
        };

        window.resetLevel6 = function() {
            clearMessage();
            level6SubmitBtn.classList.remove('hidden');
            level6NewQuizBtn.classList.add('hidden');
            level6FinishBtn.classList.add('hidden');
            level6SubmitBtn.classList.remove('hidden');
            generateLevel6Questions();
        };

        // --- Interactive Tool Functions ---
        // Helper function to draw axes on a canvas
        function drawAxes(ctx, canvas, minX, maxX, minY, maxY, xLabel, yLabel) {
            const padding = Math.max(40, Math.min(canvas.width, canvas.height) * 0.08); // Responsive padding
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const plotWidth = canvasWidth - 2 * padding;
            const plotHeight = canvasHeight - 2 * padding;
            const fontSize = Math.max(10, Math.min(canvas.width, canvas.height) * 0.025); // Responsive font size

            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            ctx.fillStyle = '#1f2937';
            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 1;
            ctx.font = `${fontSize}px Inter`;

            // Draw X-axis
            ctx.beginPath();
            ctx.moveTo(padding, canvasHeight - padding);
            ctx.lineTo(canvasWidth - padding, canvasHeight - padding);
            ctx.stroke();

            // Draw Y-axis
            ctx.beginPath();
            ctx.moveTo(padding, canvasHeight - padding);
            ctx.lineTo(padding, padding);
            ctx.stroke();

            // Draw X-axis labels and ticks
            const numXLabels = 5;
            const xStep = (maxX - minX) / numXLabels;
            for (let i = 0; i <= numXLabels; i++) {
                const x = padding + (i / numXLabels) * plotWidth;
                const label = (minX + i * xStep).toFixed(1);
                ctx.fillText(label, x - ctx.measureText(label).width / 2, canvasHeight - padding + fontSize * 2);
                ctx.beginPath();
                ctx.moveTo(x, canvasHeight - padding);
                ctx.lineTo(x, canvasHeight - padding + 5);
                ctx.stroke();
            }

            // Draw Y-axis labels and ticks
            const numYLabels = 5;
            const yStep = (maxY - minY) / numYLabels;
            for (let i = 0; i <= numYLabels; i++) {
                const y = canvasHeight - padding - (i / numYLabels) * plotHeight;
                const label = (minY + i * yStep).toFixed(1);
                ctx.fillText(label, padding - fontSize * 4, y + fontSize / 2);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding - 5, y);
                ctx.stroke();
            }

            // Axis labels
            ctx.fillText(xLabel, canvasWidth / 2 - ctx.measureText(xLabel).width / 2, canvasHeight - fontSize);
            ctx.save();
            ctx.translate(padding / 2, canvasHeight / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText(yLabel, -ctx.measureText(yLabel).width / 2, 0);
            ctx.restore();
        }

        // Function to handle plot view toggling
        window.togglePlotView = function(view) {
            if (view === 'time') {
                solutionCanvas.classList.remove('hidden');
                phaseSpaceCanvas.classList.add('hidden');
                timePlotBtn.classList.add('selected-btn');
                timePlotBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                phasePlotBtn.classList.remove('selected-btn');
                phasePlotBtn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
            } else if (view === 'phase') {
                solutionCanvas.classList.add('hidden');
                phaseSpaceCanvas.classList.remove('hidden');
                phasePlotBtn.classList.add('selected-btn');
                phasePlotBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                timePlotBtn.classList.remove('selected-btn');
                timePlotBtn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
            }
            plotSolutions();
        };

        // Main function to calculate and plot both solutions
        function plotSolutions() {
            const b = parseFloat(bInput.value);
            const c = parseFloat(cInput.value);
            const y0 = parseFloat(y0Input.value);
            const yp0 = parseFloat(yp0Input.value);
            const tStart = parseFloat(tStartInput.value);
            const tEnd = parseFloat(tEndInput.value);

            if (isNaN(b) || isNaN(c) || isNaN(y0) || isNaN(yp0) || isNaN(tStart) || isNaN(tEnd) || tStart >= tEnd) {
                // If any input is invalid, clear plots and show error
                drawAxes(solutionCtx, solutionCanvas, 0, 1, 0, 1, "Time (t)", "y(t)");
                drawAxes(phaseSpaceCtx, phaseSpaceCanvas, 0, 1, 0, 1, "y(t)", "y'(t)");
                noSolutionMessage.classList.remove('hidden');
                return;
            }
            noSolutionMessage.classList.add('hidden');

            // Calculate solution functions
            const { solutionFunc, derivativeFunc, dampingType } = calculateSolution(b, c, y0, yp0);

            // Update damping type display
            dampingTypeDisplay.textContent = dampingType;
            dampingTypeDisplay.className = 'font-bold';
            if (dampingType === 'Undamped') dampingTypeDisplay.classList.add('text-green-600');
            else if (dampingType === 'Lightly Damped') dampingTypeDisplay.classList.add('text-blue-600');
            else if (dampingType === 'Critically Damped') dampingTypeDisplay.classList.add('text-yellow-600');
            else if (dampingType === 'Overdamped') dampingTypeDisplay.classList.add('text-red-600');
            else dampingTypeDisplay.classList.add('text-gray-600');

            // Generate data points
            const points = generateSolutionPoints(solutionFunc, derivativeFunc, tStart, tEnd);

            // Plot on canvases
            drawTimeDomainPlot(points, tStart, tEnd);
            drawPhaseSpacePlot(points);
        }

        // Function to calculate the solution functions based on coefficients
        function calculateSolution(b, c, y0, yp0) {
            const D = b * b - 4 * c; // Discriminant
            const epsilon = 1e-9; // Tolerance for floating-point comparison
            let solutionFunc;
            let derivativeFunc;
            let dampingType = '';

            if (b === 0 && c > 0) {
                // Undamped
                dampingType = 'Undamped';
                const omega = Math.sqrt(c);
                const A = y0;
                const B = yp0 / omega;
                solutionFunc = t => A * Math.cos(omega * t) + B * Math.sin(omega * t);
                derivativeFunc = t => -A * omega * Math.sin(omega * t) + B * omega * Math.cos(omega * t);
            } else if (Math.abs(D) < epsilon) {
                // Critically Damped
                dampingType = 'Critically Damped';
                const r = -b / 2;
                const C1 = y0;
                const C2 = yp0 - r * y0;
                solutionFunc = t => (C1 + C2 * t) * Math.exp(r * t);
                derivativeFunc = t => C2 * Math.exp(r * t) + r * (C1 + C2 * t) * Math.exp(r * t);
            } else if (D > 0) {
                // Overdamped
                dampingType = 'Overdamped';
                const r1 = (-b + Math.sqrt(D)) / 2;
                const r2 = (-b - Math.sqrt(D)) / 2;
                const C1 = (yp0 - r2 * y0) / (r1 - r2);
                const C2 = y0 - C1;
                solutionFunc = t => C1 * Math.exp(r1 * t) + C2 * Math.exp(r2 * t);
                derivativeFunc = t => C1 * r1 * Math.exp(r1 * t) + C2 * r2 * Math.exp(r2 * t);
            } else if (D < 0) {
                // Lightly Damped (Underdamped)
                dampingType = 'Lightly Damped';
                const alpha = -b / 2;
                const beta = Math.sqrt(-D) / 2;
                const C1 = y0;
                const C2 = (yp0 - alpha * y0) / beta;
                solutionFunc = t => Math.exp(alpha * t) * (C1 * Math.cos(beta * t) + C2 * Math.sin(beta * t));
                derivativeFunc = t => alpha * Math.exp(alpha * t) * (C1 * Math.cos(beta * t) + C2 * Math.sin(beta * t)) + Math.exp(alpha * t) * (-C1 * beta * Math.sin(beta * t) + C2 * beta * Math.cos(beta * t));
            } else {
                // Fallback for cases with no solution (e.g., c < 0, b=0)
                dampingType = 'Unstable';
                solutionFunc = () => 0;
                derivativeFunc = () => 0;
            }

            return { solutionFunc, derivativeFunc, dampingType };
        }

        // Function to generate data points for plotting
        function generateSolutionPoints(solutionFunc, derivativeFunc, tStart, tEnd) {
            const points = [];
            const step = (tEnd - tStart) / 1000;
            for (let t = tStart; t <= tEnd; t += step) {
                const y = solutionFunc(t);
                const yp = derivativeFunc(t);
                points.push({t, y, yp});
            }
            return points;
        }

        // Function to plot the time-domain solution
        function drawTimeDomainPlot(points, tStart, tEnd) {
            const width = solutionCanvas.width;
            const height = solutionCanvas.height;
            const padding = Math.max(40, Math.min(width, height) * 0.08);
            const plotWidth = width - 2 * padding;
            const plotHeight = height - 2 * padding;

            let minY = Infinity;
            let maxY = -Infinity;

            points.forEach(point => {
                if (point.y > maxY) maxY = point.y;
                if (point.y < minY) minY = point.y;
            });

            const yRange = maxY - minY;
            const yPadding = yRange * 0.1 || 1;
            const yMinAdjusted = minY - yPadding;
            const yMaxAdjusted = maxY + yPadding;

            drawAxes(solutionCtx, solutionCanvas, tStart, tEnd, yMinAdjusted, yMaxAdjusted, "Time (t)", "y(t)");

            // Draw solution
            solutionCtx.beginPath();
            solutionCtx.strokeStyle = '#4f46e5';
            solutionCtx.lineWidth = 2;

            points.forEach((point, index) => {
                const x = padding + (point.t - tStart) / (tEnd - tStart) * plotWidth;
                const y = padding + (1 - (point.y - yMinAdjusted) / (yMaxAdjusted - yMinAdjusted)) * plotHeight;
                if (index === 0) {
                    solutionCtx.moveTo(x, y);
                } else {
                    solutionCtx.lineTo(x, y);
                }
            });
            solutionCtx.stroke();
        }

        // Function to plot the phase space
        function drawPhaseSpacePlot(points) {
            const width = phaseSpaceCanvas.width;
            const height = phaseSpaceCanvas.height;
            const padding = Math.max(40, Math.min(width, height) * 0.08);
            const plotWidth = width - 2 * padding;
            const plotHeight = height - 2 * padding;

            let minY = Infinity;
            let maxY = -Infinity;
            let minX = Infinity;
            let maxX = -Infinity;

            points.forEach(point => {
                if (point.y > maxY) maxY = point.y;
                if (point.y < minY) minY = point.y;
                if (point.yp > maxX) maxX = point.yp; // x-axis for phase space is y(t)
                if (point.yp < minX) minX = point.yp; // y-axis for phase space is y'(t)
            });

            // Adjust ranges
            const xRange = maxY - minY;
            const xPadding = xRange * 0.1 || 1;
            const xMinAdjusted = minY - xPadding;
            const xMaxAdjusted = maxY + xPadding;

            const yRange = maxX - minX;
            const yPadding = yRange * 0.1 || 1;
            const yMinAdjusted = minX - yPadding;
            const yMaxAdjusted = maxX + yPadding;

            drawAxes(phaseSpaceCtx, phaseSpaceCanvas, xMinAdjusted, xMaxAdjusted, yMinAdjusted, yMaxAdjusted, "y(t)", "y'(t)");

            // Draw phase space curve
            phaseSpaceCtx.beginPath();
            phaseSpaceCtx.strokeStyle = '#4f46e5';
            phaseSpaceCtx.lineWidth = 2;

            points.forEach((point, index) => {
                const x = padding + (point.y - xMinAdjusted) / (xMaxAdjusted - xMinAdjusted) * plotWidth;
                const y = padding + (1 - (point.yp - yMinAdjusted) / (yMaxAdjusted - yMinAdjusted)) * plotHeight;
                if (index === 0) {
                    phaseSpaceCtx.moveTo(x, y);
                } else {
                    phaseSpaceCtx.lineTo(x, y);
                }
            });
            phaseSpaceCtx.stroke();
        }

        function setupInteractiveToolListeners() {
            bInput.addEventListener('input', plotSolutions);
            cInput.addEventListener('input', plotSolutions);
            y0Input.addEventListener('input', plotSolutions);
            yp0Input.addEventListener('input', plotSolutions);
            tStartInput.addEventListener('input', plotSolutions);
            tEndInput.addEventListener('input', plotSolutions);
        }

        // Initial setup on page load
        window.onload = function() {
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitAIResponse();
                }
            });
            showMenu(); // Start with the main menu
        };
    </script>
</body>
</html>
